{% extends "base.html" %}

{% block title %}Submit Post - OpenX{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <h2 class="form-title">Create Post</h2>

        <div id="message" class="form-error" style="display: none;"></div>

        <div class="form-group">
            <label class="form-label">Branch</label>
            <select id="branch" class="form-select">
                {% set user_branch = "u_" ~ user.username %}
                <option value="{{ user_branch }}" {% if selected_branch == user_branch %}selected{% endif %}>My Profile (u/{{ user.username }})</option>
                <option value="" disabled>── Other branches ──</option>
                {% for b in branches %}
                    {% if b.name != user_branch %}
                    <option value="{{ b.name }}" {% if selected_branch == b.name %}selected{% endif %}>b/{{ b.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Content</label>
            <textarea id="content" class="form-textarea" placeholder="Write your post content..." rows="6"></textarea>
        </div>

        <!-- Media upload section -->
        <div class="form-group">
            <input type="file" id="mediaInput" accept="image/*,video/*" style="display: none;" onchange="handleMediaSelect(event)">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('mediaInput').click()">
                Attach Media
            </button>
            <span id="mediaStatus" class="media-status"></span>
        </div>

        <!-- Media preview -->
        <div id="mediaPreview" class="media-preview" style="display: none;">
            <div class="media-preview-container">
                <img id="imagePreview" class="media-preview-img" style="display: none;">
                <video id="videoPreview" class="media-preview-video" controls style="display: none;"></video>
                <button type="button" class="media-remove-btn" onclick="removeMedia()" title="Remove media">
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                </button>
            </div>
        </div>

        <button type="button" class="btn btn-primary btn-full" onclick="submitPost()">Submit</button>
    </div>
</div>

<style>
.media-status {
    margin-left: 10px;
    color: #666;
    font-size: 0.9em;
}

.media-preview {
    margin-bottom: 20px;
}

.media-preview-container {
    position: relative;
    display: inline-block;
    max-width: 100%;
}

.media-preview-img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
}

.media-preview-video {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
}

.media-remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.media-remove-btn:hover {
    background: rgba(220, 53, 69, 0.9);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let uploadedMedia = null;  // { url, type, alt_text }

async function handleMediaSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const mediaStatus = document.getElementById('mediaStatus');
    mediaStatus.textContent = 'Uploading...';

    try {
        const result = await uploadMedia(file);
        uploadedMedia = {
            url: result.url,
            type: result.media_type,
            alt_text: ''
        };

        // Show preview
        const preview = document.getElementById('mediaPreview');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');

        if (result.media_type === 'image') {
            imagePreview.src = result.url;
            imagePreview.style.display = 'block';
            videoPreview.style.display = 'none';
        } else if (result.media_type === 'video') {
            videoPreview.src = result.url;
            videoPreview.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        preview.style.display = 'block';
        mediaStatus.textContent = 'Media attached';

    } catch (error) {
        mediaStatus.textContent = 'Upload failed: ' + error.message;
        uploadedMedia = null;
    }
}

function removeMedia() {
    uploadedMedia = null;
    document.getElementById('mediaPreview').style.display = 'none';
    document.getElementById('mediaInput').value = '';
    document.getElementById('mediaStatus').textContent = '';
    document.getElementById('imagePreview').src = '';
    document.getElementById('videoPreview').src = '';
}

async function submitPost() {
    const messageEl = document.getElementById('message');
    const content = document.getElementById('content').value.trim();
    const branch = document.getElementById('branch').value;

    hideMessage(messageEl);

    if (!content && !uploadedMedia) {
        showError(messageEl, 'Content or media is required');
        return;
    }

    if (!branch) {
        showError(messageEl, 'Please select a branch');
        return;
    }

    // Build post data based on whether media is attached
    let postData = {
        content: content || '',
        to_branch: branch
    };

    if (uploadedMedia) {
        if (uploadedMedia.type === 'image') {
            postData.type = 'image';
            postData.image_url = uploadedMedia.url;
            postData.alt_text = uploadedMedia.alt_text || '';
        } else if (uploadedMedia.type === 'video') {
            postData.type = 'video';
            postData.video_url = uploadedMedia.url;
        }
    } else {
        postData.type = 'text';
    }

    try {
        await createBranchPost(branch, postData);
        showSuccess(messageEl, 'Post created! Redirecting...');
        setTimeout(() => {
            window.location.href = '/b/' + branch;
        }, 1000);
    } catch (error) {
        showError(messageEl, 'Failed to create post: ' + error.message);
    }
}
</script>
{% endblock %}
