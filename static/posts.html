<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenX - Posts</title>
</head>
<body>
    <header>
        <h1>OpenX</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="register.html">Register</a>
            <a href="login.html">Login</a>
            <a href="profile.html">Profile</a>
            <a href="posts.html">Posts</a>
            <a href="media.html">Media</a>
        </nav>
    </header>

    <main>
        <section>
            <h2>Create Post</h2>

            <div id="authWarning" style="display: none;">
                <p style="color: orange;">Warning: You are not authenticated. Please <a href="login.html">login</a> first to create posts.</p>
            </div>

            <form id="createPostForm">
                <div>
                    <label for="postType">Post Type:</label>
                    <br>
                    <select id="postType" name="postType" onchange="togglePostFields()">
                        <option value="text">Text</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <br>

                <div>
                    <label for="content">Content:</label>
                    <br>
                    <textarea id="content" name="content" required maxlength="4096" rows="4" cols="50"></textarea>
                </div>
                <br>

                <div>
                    <label for="toBranch">Post to Branch (optional):</label>
                    <br>
                    <input type="text" id="toBranch" name="toBranch">
                </div>
                <br>

                <div id="textFields">
                    <label for="formatting">Formatting (optional):</label>
                    <br>
                    <input type="text" id="formatting" name="formatting" maxlength="50">
                </div>

                <div id="imageFields" style="display: none;">
                    <label for="imageUrl">Image URL:</label>
                    <br>
                    <input type="url" id="imageUrl" name="imageUrl" maxlength="512">
                    <br><br>
                    <label for="imageWidth">Width (optional):</label>
                    <br>
                    <input type="number" id="imageWidth" name="imageWidth">
                    <br><br>
                    <label for="imageHeight">Height (optional):</label>
                    <br>
                    <input type="number" id="imageHeight" name="imageHeight">
                    <br><br>
                    <label for="altText">Alt Text (optional):</label>
                    <br>
                    <input type="text" id="altText" name="altText" maxlength="256">
                </div>

                <div id="videoFields" style="display: none;">
                    <label for="videoUrl">Video URL:</label>
                    <br>
                    <input type="url" id="videoUrl" name="videoUrl" maxlength="512">
                    <br><br>
                    <label for="thumbnailUrl">Thumbnail URL (optional):</label>
                    <br>
                    <input type="url" id="thumbnailUrl" name="thumbnailUrl">
                    <br><br>
                    <label for="duration">Duration in seconds (optional):</label>
                    <br>
                    <input type="number" id="duration" name="duration">
                </div>

                <br>
                <button type="submit">Create Post</button>
            </form>

            <div id="createResult" style="display: none;">
                <h3>Post Created!</h3>
                <p id="createResultContent"></p>
            </div>

            <div id="createError" style="display: none; color: red;">
                <p id="createErrorMessage"></p>
            </div>
        </section>

        <hr>

        <section>
            <h2>Update Post</h2>

            <form id="updatePostForm">
                <div>
                    <label for="updatePostId">Post ID:</label>
                    <br>
                    <input type="text" id="updatePostId" name="updatePostId" required>
                </div>
                <br>

                <div>
                    <label for="updateContent">New Content (optional):</label>
                    <br>
                    <textarea id="updateContent" name="updateContent" maxlength="4096" rows="2" cols="50"></textarea>
                </div>
                <br>

                <div>
                    <label for="updateFormatting">New Formatting (optional):</label>
                    <br>
                    <input type="text" id="updateFormatting" name="updateFormatting" maxlength="50">
                </div>

                <br>
                <button type="submit">Update Post</button>
            </form>

            <div id="updateResult" style="display: none;">
                <h3>Post Updated!</h3>
                <p id="updateResultContent"></p>
            </div>

            <div id="updateError" style="display: none; color: red;">
                <p id="updateErrorMessage"></p>
            </div>
        </section>

        <hr>

        <section>
            <h2>Delete Post</h2>

            <form id="deletePostForm">
                <div>
                    <label for="deletePostId">Post ID:</label>
                    <br>
                    <input type="text" id="deletePostId" name="deletePostId" required>
                </div>
                <br>
                <button type="submit" onclick="return confirm('Are you sure you want to delete this post?')">Delete Post</button>
            </form>

            <div id="deleteResult" style="display: none;">
                <p style="color: green;">Post deleted successfully!</p>
            </div>

            <div id="deleteError" style="display: none; color: red;">
                <p id="deleteErrorMessage"></p>
            </div>
        </section>

        <section>
            <h3>API Details</h3>
            <h4>Create Post</h4>
            <p><strong>Endpoint:</strong> POST /api/user/posts/</p>
            <p><strong>Auth:</strong> Requires X-Secret-Key header</p>

            <h4>Update Post</h4>
            <p><strong>Endpoint:</strong> PATCH /api/user/posts/{post_id}/</p>
            <p><strong>Auth:</strong> Requires X-Secret-Key header (must be owner)</p>

            <h4>Delete Post</h4>
            <p><strong>Endpoint:</strong> DELETE /api/user/posts/{post_id}/</p>
            <p><strong>Auth:</strong> Requires X-Secret-Key header (must be owner)</p>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 OpenX</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const secretKey = sessionStorage.getItem('secretKey');
            if (!secretKey) {
                document.getElementById('authWarning').style.display = 'block';
            }
        });

        function togglePostFields() {
            const postType = document.getElementById('postType').value;

            document.getElementById('textFields').style.display = postType === 'text' ? 'block' : 'none';
            document.getElementById('imageFields').style.display = postType === 'image' ? 'block' : 'none';
            document.getElementById('videoFields').style.display = postType === 'video' ? 'block' : 'none';
        }

        function getSecretKey() {
            return sessionStorage.getItem('secretKey');
        }

        document.getElementById('createPostForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const secretKey = getSecretKey();
            if (!secretKey) {
                alert('Please login first!');
                return;
            }

            const postType = document.getElementById('postType').value;
            const content = document.getElementById('content').value;
            const toBranch = document.getElementById('toBranch').value || null;

            let body = {
                type: postType,
                content: content
            };

            if (toBranch) body.to_branch = toBranch;

            if (postType === 'text') {
                const formatting = document.getElementById('formatting').value;
                if (formatting) body.formatting = formatting;
            } else if (postType === 'image') {
                const imageUrl = document.getElementById('imageUrl').value;
                if (!imageUrl) {
                    alert('Image URL is required for image posts');
                    return;
                }
                body.image_url = imageUrl;
                if (document.getElementById('imageWidth').value) body.width = parseInt(document.getElementById('imageWidth').value);
                if (document.getElementById('imageHeight').value) body.height = parseInt(document.getElementById('imageHeight').value);
                if (document.getElementById('altText').value) body.alt_text = document.getElementById('altText').value;
            } else if (postType === 'video') {
                const videoUrl = document.getElementById('videoUrl').value;
                if (!videoUrl) {
                    alert('Video URL is required for video posts');
                    return;
                }
                body.video_url = videoUrl;
                if (document.getElementById('thumbnailUrl').value) body.thumbnail_url = document.getElementById('thumbnailUrl').value;
                if (document.getElementById('duration').value) body.duration_seconds = parseInt(document.getElementById('duration').value);
            }

            try {
                const response = await fetch('/api/user/posts/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Secret-Key': secretKey
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('createResultContent').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('createResult').style.display = 'block';
                    document.getElementById('createError').style.display = 'none';
                } else {
                    document.getElementById('createErrorMessage').textContent = data.detail || 'Failed to create post';
                    document.getElementById('createError').style.display = 'block';
                    document.getElementById('createResult').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('createErrorMessage').textContent = 'Network error: ' + error.message;
                document.getElementById('createError').style.display = 'block';
            }
        });

        document.getElementById('updatePostForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const secretKey = getSecretKey();
            if (!secretKey) {
                alert('Please login first!');
                return;
            }

            const postId = document.getElementById('updatePostId').value;
            let body = {};

            const content = document.getElementById('updateContent').value;
            const formatting = document.getElementById('updateFormatting').value;

            if (content) body.content = content;
            if (formatting) body.formatting = formatting;

            if (Object.keys(body).length === 0) {
                alert('Please provide at least one field to update');
                return;
            }

            try {
                const response = await fetch(`/api/user/posts/${postId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Secret-Key': secretKey
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('updateResultContent').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('updateResult').style.display = 'block';
                    document.getElementById('updateError').style.display = 'none';
                } else {
                    document.getElementById('updateErrorMessage').textContent = data.detail || 'Failed to update post';
                    document.getElementById('updateError').style.display = 'block';
                    document.getElementById('updateResult').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('updateErrorMessage').textContent = 'Network error: ' + error.message;
                document.getElementById('updateError').style.display = 'block';
            }
        });

        document.getElementById('deletePostForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const secretKey = getSecretKey();
            if (!secretKey) {
                alert('Please login first!');
                return;
            }

            const postId = document.getElementById('deletePostId').value;

            try {
                const response = await fetch(`/api/user/posts/${postId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-Secret-Key': secretKey
                    }
                });

                if (response.ok || response.status === 204) {
                    document.getElementById('deleteResult').style.display = 'block';
                    document.getElementById('deleteError').style.display = 'none';
                } else {
                    const data = await response.json();
                    document.getElementById('deleteErrorMessage').textContent = data.detail || 'Failed to delete post';
                    document.getElementById('deleteError').style.display = 'block';
                    document.getElementById('deleteResult').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('deleteErrorMessage').textContent = 'Network error: ' + error.message;
                document.getElementById('deleteError').style.display = 'block';
            }
        });
    </script>
</body>
</html>
