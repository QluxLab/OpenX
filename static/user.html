<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenX</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-logo">OpenX</a>
        <nav class="header-nav">
            <a href="index.html">Home</a>
        </nav>
        <div class="header-user" id="userMenu">
            <div class="user-avatar" id="userAvatar" style="display: none;"></div>
            <a href="login.html" id="loginLink">Login</a>
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item" onclick="goToProfile()">Profile</div>
                <div class="user-dropdown-item" onclick="goToSettings()">Settings</div>
                <div class="user-dropdown-divider"></div>
                <div class="user-dropdown-item" onclick="logout()">Logout</div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <main class="content-feed">
            <!-- Profile Header -->
            <div class="card">
                <div class="user-card" style="padding: 1.5rem;">
                    <div class="user-card-avatar" id="profileAvatar" style="width: 64px; height: 64px; font-size: 1.5rem;"></div>
                    <div class="user-card-info">
                        <div class="user-card-name" id="profileName" style="font-size: 1.25rem;"></div>
                        <div class="user-card-handle" id="profileHandle"></div>
                    </div>
                </div>
            </div>

            <!-- Posts -->
            <div id="postsContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading posts...</p>
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="card" id="userCard" style="display: none;">
                <div class="user-card">
                    <div class="user-card-avatar" id="sidebarAvatar"></div>
                    <div class="user-card-info">
                        <div class="user-card-name" id="sidebarUsername"></div>
                        <div class="user-card-handle" id="sidebarHandle"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="widget-title">Search Users</div>
                    <input type="text" class="search-input" id="searchInput" placeholder="Username..." onkeypress="handleSearch(event)">
                </div>
            </div>
        </aside>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Post</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea class="form-input form-textarea" id="editContent" maxlength="4096"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Delete Post</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this post? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let viewingUser = null;
        let editingPostId = null;
        let deletingPostId = null;

        const avatarColors = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e',
            '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1',
            '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'
        ];

        function getAvatarColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return avatarColors[Math.abs(hash) % avatarColors.length];
        }

        function getAvatarLetter(username) {
            return username.charAt(0).toUpperCase();
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const secretKey = sessionStorage.getItem('secretKey');
            const username = sessionStorage.getItem('username');

            if (secretKey && username) {
                currentUser = { username, secretKey };
                showLoggedInState();
            } else {
                document.getElementById('loginLink').style.display = 'block';
            }

            // Get viewing user from URL
            const params = new URLSearchParams(window.location.search);
            viewingUser = params.get('u');

            if (viewingUser) {
                await loadUserPosts();
            } else {
                document.getElementById('postsContainer').innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <p>User not found.</p>
                        </div>
                    </div>
                `;
            }

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.header-user')) {
                    document.getElementById('userDropdown').classList.remove('show');
                }
                if (!e.target.closest('.post-menu')) {
                    document.querySelectorAll('.post-menu-dropdown').forEach(d => d.classList.remove('show'));
                }
            });
        });

        function showLoggedInState() {
            document.getElementById('userAvatar').style.display = 'flex';
            document.getElementById('userAvatar').textContent = getAvatarLetter(currentUser.username);
            document.getElementById('userAvatar').style.backgroundColor = getAvatarColor(currentUser.username);
            document.getElementById('loginLink').style.display = 'none';
            document.getElementById('userCard').style.display = 'block';

            document.getElementById('sidebarAvatar').textContent = getAvatarLetter(currentUser.username);
            document.getElementById('sidebarAvatar').style.backgroundColor = getAvatarColor(currentUser.username);
            document.getElementById('sidebarUsername').textContent = currentUser.username;
            document.getElementById('sidebarHandle').textContent = '@' + currentUser.username.toLowerCase();
        }

        document.getElementById('userAvatar').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('userDropdown').classList.toggle('show');
        });

        function goToProfile() {
            window.location.href = 'user.html?u=' + currentUser.username;
        }

        function goToSettings() {
            window.location.href = 'settings.html';
        }

        function logout() {
            sessionStorage.removeItem('secretKey');
            sessionStorage.removeItem('username');
            window.location.reload();
        }

        function handleSearch(e) {
            if (e.key === 'Enter') {
                const username = document.getElementById('searchInput').value.trim();
                if (username) {
                    window.location.href = 'user.html?u=' + username;
                }
            }
        }

        window.loadUserPosts = async function() {
            const container = document.getElementById('postsContainer');

            // Set profile header
            document.getElementById('profileAvatar').textContent = getAvatarLetter(viewingUser);
            document.getElementById('profileAvatar').style.backgroundColor = getAvatarColor(viewingUser);
            document.getElementById('profileName').textContent = viewingUser;
            document.getElementById('profileHandle').textContent = '@' + viewingUser.toLowerCase();
            document.title = viewingUser + ' - OpenX';

            try {
                const response = await fetch(`/api/user/${viewingUser}/posts/?include_branch_posts=true`);
                const posts = await response.json();

                if (!response.ok) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <p>${posts.detail || 'Failed to load posts'}</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (posts.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="empty-state">
                                <div class="empty-state-icon">&#128221;</div>
                                <h3 style="margin-bottom: 0.5rem; color: #c0c0c0;">No posts yet</h3>
                                <p>This user hasn't posted anything.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                const isOwner = currentUser && currentUser.username === viewingUser;
                container.innerHTML = posts.map(post => renderPost(post, isOwner)).join('');

            } catch (error) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <p>Network error: ${error.message}</p>
                        </div>
                    </div>
                `;
            }
        };

        function togglePostMenu(postId) {
            const dropdown = document.getElementById('menu-' + postId);
            dropdown.classList.toggle('show');
        }

        function openEditModal(postId, content) {
            editingPostId = postId;
            document.getElementById('editContent').value = content;
            document.getElementById('editModal').classList.add('show');
            closeAllMenus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            editingPostId = null;
        }

        async function saveEdit() {
            const content = document.getElementById('editContent').value.trim();
            if (!content) return;

            try {
                const response = await fetch(`/api/user/posts/${editingPostId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Secret-Key': currentUser.secretKey
                    },
                    body: JSON.stringify({ content })
                });

                if (!response.ok) throw new Error('Failed to update');
                closeEditModal();
                await window.loadUserPosts();
            } catch (error) {
                alert(error.message);
            }
        }

        function openDeleteModal(postId) {
            deletingPostId = postId;
            document.getElementById('deleteModal').classList.add('show');
            closeAllMenus();
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deletingPostId = null;
        }

        async function confirmDelete() {
            try {
                const response = await fetch(`/api/user/posts/${deletingPostId}/`, {
                    method: 'DELETE',
                    headers: { 'X-Secret-Key': currentUser.secretKey }
                });

                if (!response.ok) throw new Error('Failed to delete');
                closeDeleteModal();
                await window.loadUserPosts();
            } catch (error) {
                alert(error.message);
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.post-menu-dropdown').forEach(d => d.classList.remove('show'));
        }

        function renderPost(post, isOwner = false) {
            const avatarColor = getAvatarColor(post.author_id || 'user');
            const avatarLetter = getAvatarLetter(post.author_id || 'U');
            const date = new Date(post.created_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            let mediaHtml = '';
            if (post.type === 'image' && post.image_url) {
                mediaHtml = `<img class="post-image" src="${post.image_url}" alt="">`;
            } else if (post.type === 'video' && post.video_url) {
                mediaHtml = `<video class="post-video" src="${post.video_url}" controls></video>`;
            }

            let menuHtml = '';
            if (isOwner) {
                menuHtml = `
                    <div class="post-menu">
                        <button class="post-menu-btn" onclick="togglePostMenu('${post.id}')">&#8942;</button>
                        <div class="post-menu-dropdown" id="menu-${post.id}">
                            <div class="post-menu-item" onclick="openEditModal('${post.id}', \`${escapeJs(post.content)}\`)">Edit</div>
                            <div class="post-menu-item delete" onclick="openDeleteModal('${post.id}')">Delete</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="card post" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="post-author">
                            <div class="post-author-avatar" style="background-color: ${avatarColor}">${avatarLetter}</div>
                            <div class="post-author-info">
                                <a href="user.html?u=${post.author_id}" class="post-author-name">${post.author_id}</a>
                                <span class="post-date">${date}</span>
                            </div>
                        </div>
                        ${menuHtml}
                    </div>
                    <div class="post-content">
                        <p>${escapeHtml(post.content)}</p>
                    </div>
                    ${mediaHtml}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJs(text) {
            return text.replace(/`/g, '\\`').replace(/\\/g, '\\\\');
        }
    </script>
</body>
</html>
